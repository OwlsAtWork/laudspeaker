# To build : docker build -f Dockerfile.dev.server -t laudspeaker-api:latest .
# To run: docker run -it -p 3001:3001 --rm laudspeaker-api:latest
FROM node:16 as build
WORKDIR /app
COPY ./packages/server/package.json /app
RUN npm install --legacy-peer-deps
COPY . /app
RUN npm run build:server

FROM node:16 As Development
ARG NODE_ENV=development
ENV NODE_ENV=${NODE_ENV}
ENV MAGIC_EMAIL_KEY=${MAGIC_EMAIL_KEY}
ENV MAGIC_EMAIL_DOMAIN=${MAGIC_EMAIL_DOMAIN}
ENV SLACK_CLIENT_ID=${SLACK_CLIENT_ID}
ENV SLACK_CLIENT_SECRET=${SLACK_CLIENT_SECRET}
ENV SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}
ENV SENDING_TO_TEST_EMAIL=${SENDING_TO_TEST_EMAIL}
ENV POSTHOG_PROJECT_ID=${TESTS_POSTHOG_PROJECT_ID}
ENV POSTHOG_API_KEY=phc_MvypYfRDuzzcwISCM9x7hcb5pMthxHA2aF8pJFjoWCY
ENV POSTHOG_HOST_URL=https://app.posthog.com
ENV MAILGUN_API_KEY=${MAGIC_EMAIL_KEY}
ENV TESTS_INSTALLATION_JSON=${TESTS_INSTALLATION_JSON}
ENV TESTS_INSTALLATION_ID=${TESTS_INSTALLATION_ID}
ENV PORT=3001
ENV NODE_ENV=development
ENV FRONTEND_URL=localhost:8082
ENV ENVIRONMENT=development
ENV DATABASE_HOST=postgres
ENV DATABASE_NAME=laudspeaker
ENV DATABASE_USER=postgres
ENV DATABASE_PASSWORD=password
ENV DATABASE_PORT=5432
ENV SYNCHRONIZE=true
ENV JWT_KEY=dev
ENV JWT_EXPIRES=365d
ENV REDIS_HOST=redis
ENV REDIS_PORT=6379
ENV REDIS_PASSWORD=
ENV MONGOOSE_URL=mongodb://mongo:27017/nest
ENV MAILGUN_DOMAIN=${MAGIC_EMAIL_DOMAIN}
ENV MAILGUN_TEST_DOMAIN=${MAGIC_EMAIL_DOMAIN}
ENV SENDGRID_WEBHOOK_ENDPOINT=${SENDGRID_WEBHOOK_ENDPOINT}
ENV CLICKHOUSE_HOST=http://clickhouse:8123
ENV CLICKHOUSE_USER=default
ENV CLICKHOUSE_PASSWORD=
ENV KAFKA_BROKERS_LIST='kafka1:19092,kafka1:9092'
ENV MINIO_S3_URL=http://s3:9000
ENV AWS_S3_ACCESS_KEY=VWo0IKy57IT0ARYVuRp2
ENV AWS_S3_KEY_SECRET=4cl2bJdjkjH7RkEa0EzL8JyN2OVBXdgyGQlzH5Md
ENV AWS_S3_BUCKET=laudspeaker
ENV AWS_S3_CUSTOMERS_IMPORT_BUCKET=laudspeaker
WORKDIR /app
COPY ./packages/server/package.json /app
RUN npm install --only=production --legacy-peer-deps
COPY --from=build /app/packages/server/dist /app/dist
EXPOSE 3001
CMD ["node", "dist/src/main.js"]
